#! /bin/bash

# Config variable, modify to your needs
EMAIL_TO='recipient@email.com'
EMAIL_FROM='sender@email.com'
EMAIL_SUBJECT="File changes on $(date +%Y-%m-%d)"
FOLDER_PATH='/home/[username]/public_html'
declare -a IGNORED_FOLDERS=(
	'/images/user-cards'
	'/images/profile-covers'
);
declare -a IGNORED_FILES=(
	'error_log'
);

# Find all changes made in the past 1 day (24h), send errors to /dev/null
echo 'Fecthing changes, this may take a few minutes.'
files=( $(find $FOLDER_PATH -ctime -1 2> /dev/null) )
echo '=============================================='

# Remove file instances that match from ignored folders list
for ign_folder in ${IGNORED_FOLDERS[@]}; do
	# Construct absolute path
	ign_folder="$FOLDER_PATH$ign_folder"
  
  # Escape forward-slashes
  ign_folder=${ign_folder//\//\\\/}

  # Remove ignored folder files with pattern match
  files=( ${files[@]/$ign_folder*/} )
done

# Remove file instances that match from ignored files list
for ign_file in ${IGNORED_FILES[@]}; do
  # Remove ignored files with pattern match
  files=( ${files[@]/*$ign_file/} )
done

# Display results to terminal screen
for file in ${files[@]}; do
	echo $file
  output+="$file\n" # Add newline for email output
done

# Send an email with list of changed files
message="subject:$EMAIL_SUBJECT\nfrom:$EMAIL_FROM\n$output"
echo -e $message | sendmail $EMAIL_TO 
echo "Email sent to $EMAIL_TO"

unset files
